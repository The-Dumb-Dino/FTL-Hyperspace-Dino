#include "CrashReportFlow.h"
#include "../core/CrashDetector.h"
#include "../core/CrashReporter.h"
#include "../ui/CrashDialogManager.h"
#include "Global.h"

CrashReportFlow* CrashReportFlow::instance = nullptr;

CrashReportFlow::CrashReportFlow()
{
}

CrashReportFlow* CrashReportFlow::GetInstance()
{
    if (instance == nullptr)
    {
        instance = new CrashReportFlow();
    }
    return instance;
}

// Render all crash reporting dialogs
void CrashReportFlow::OnRender()
{
    CrashDialogManager::GetInstance()->OnRender();
}

// Initialize crash detection on menu open
void CrashReportFlow::OnMenuOpen()
{
    if (initialized)
    {
        return;  // Only initialize once
    }

    CrashDetector::GetInstance()->OnInit();
    initialized = true;

    // If crash detected, show Dialog 1: "Do you want to report this crash?"
    if (CrashDetector::GetInstance()->WasCrashDetected())
    {
        CrashDialogManager::GetInstance()->ShowAskReportDialog();
    }
}

// Handle dialog mouse click events
void CrashReportFlow::OnMouseClick(int x, int y, bool& shouldPropagate)
{
    // Dialog 1: "Do you want to report this crash?"
    if (CrashDialogManager::GetInstance()->IsAskReportDialogOpen())
    {
        CrashDialogManager::GetInstance()->OnMouseClick(x, y, shouldPropagate);

        if (!CrashDialogManager::GetInstance()->IsAskReportDialogOpen())
        {
            HandleAskReportResult();
        }
        return;
    }

    // Dialog 2: "Report to Discord or GitHub?"
    if (CrashDialogManager::GetInstance()->IsChooseDestinationDialogOpen())
    {
        CrashDialogManager::GetInstance()->OnMouseClick(x, y, shouldPropagate);

        if (!CrashDialogManager::GetInstance()->IsChooseDestinationDialogOpen())
        {
            HandleChooseDestinationResult();
        }
        return;
    }

    // Dialog 3: "Here's how to report + Open folder"
    if (CrashDialogManager::GetInstance()->IsInstructionsDialogOpen())
    {
        CrashDialogManager::GetInstance()->OnMouseClick(x, y, shouldPropagate);

        if (!CrashDialogManager::GetInstance()->IsInstructionsDialogOpen())
        {
            HandleInstructionsResult();
        }
        return;
    }

    // Error dialog: Just closes, no action needed
    if (CrashDialogManager::GetInstance()->IsErrorDialogOpen())
    {
        CrashDialogManager::GetInstance()->OnMouseClick(x, y, shouldPropagate);
        return;
    }

    shouldPropagate = true;
}


// Handle dialog mouse move events
void CrashReportFlow::OnMouseMove(int x, int y, bool& shouldPropagate)
{
    if (CrashDialogManager::GetInstance()->AnyCrashDialogOpen())
    {
        CrashDialogManager::GetInstance()->OnMouseMove(x, y, shouldPropagate);
        return;
    }

    shouldPropagate = true;
}

void CrashReportFlow::OnGameExit()
{
    CrashDetector::GetInstance()->OnExit();
}

void CrashReportFlow::HandleAskReportResult()
{
    // Dialog 1 result: true = "Create Report", false = "Skip"
    if (CrashDialogManager::GetInstance()->GetAskReportResult())
    {
        // Create bug report and get the path
        lastBugReportPath = CrashReporter::GetInstance()->CreateBugReportZip();

        // Check if zip creation failed
        if (lastBugReportPath.empty())
        {
            // Show error dialog
            CrashDialogManager::GetInstance()->ShowErrorDialog();
            return;
        }

        // Show Dialog 2: "Report to Discord or GitHub?"
        CrashDialogManager::GetInstance()->ShowChooseDestinationDialog();
    }
    // else -> auto close dialog, do nothing
}

void CrashReportFlow::HandleChooseDestinationResult()
{
    // Dialog 2 result: true = Discord, false = GitHub
    discordSelected = CrashDialogManager::GetInstance()->GetChooseDestinationResult();

    // Show Dialog 3: "Here's how to report + Open folder"
    CrashDialogManager::GetInstance()->ShowInstructionsDialog(lastBugReportPath, discordSelected);
}

void CrashReportFlow::HandleInstructionsResult()
{
    // Dialog 3 result: true = "Open Folder", false = "Done"
    if (CrashDialogManager::GetInstance()->GetInstructionsResult())
    {
        // Open bug report folder
        CrashReporter::GetInstance()->OpenBugReport(lastBugReportPath);

        // Reopen Dialog 3 so user can click "Done" again
        CrashDialogManager::GetInstance()->ShowInstructionsDialog(lastBugReportPath, discordSelected);
    }
    // else -> auto close dialog, do nothing
}
